apiVersion: apps/v1
kind: Deployment
metadata:
  name: config-server
  namespace: dotstat
spec:
  replicas: 1
  selector: { matchLabels: { app: config-server } }
  template:
    metadata:
      labels: { app: config-server }
    spec:
      nodeSelector:
        kubernetes.io/hostname: k3d-dotstat-server-0
      initContainers:
        - name: ensure-config-dirs
          image: busybox:1.36
          command: ["sh","-lc"]
          args:
            - |
              mkdir -p /app/data/configs/demo/data-explorer \
                       /app/data/configs/demo/data-lifecycle-manager \
                       /app/data/configs/demo/data-viewer || true
          volumeMounts:
            - name: config-data
              mountPath: /app/data
      containers:
        - name: config-server
          image: siscc/dotstatsuite-config:causality
          env:
            - name: DATA_DIR
              valueFrom: { configMapKeyRef: { name: dotstat-config, key: DATA_DIRECTORY } }
            - name: BUCKET_PROVIDER
              valueFrom: { configMapKeyRef: { name: dotstat-config, key: CONFIG_DATA_PROVIDER } }
            - name: SERVER_HOST
              value: 0.0.0.0
            - name: SERVER_PORT
              value: "80"
          ports:
            - containerPort: 80
          readinessProbe:
            tcpSocket: { port: 80 }
            initialDelaySeconds: 3
            periodSeconds: 5
          volumeMounts:
            - name: config-data
              mountPath: /app/data
            - name: seed-configs
              mountPath: /app/data/configs/tenants.json
              subPath: tenants.json
              readOnly: true
            - name: seed-configs
              mountPath: /app/data/configs/sfs.json
              subPath: sfs.json
              readOnly: true
            - name: seed-configs
              mountPath: /app/data/configs/demo/data-explorer/settings.json
              subPath: data-explorer-settings.json
              readOnly: true
            - name: seed-configs
              mountPath: /app/data/configs/demo/data-lifecycle-manager/settings.json
              subPath: data-lifecycle-manager-settings.json
              readOnly: true
            - name: seed-configs
              mountPath: /app/data/configs/demo/data-viewer/settings.json
              subPath: data-viewer-settings.json
              readOnly: true
      volumes:
        - name: config-data
          persistentVolumeClaim:
            claimName: pvc-config-data
        - name: seed-configs
          configMap:
            name: seed-configs
---
apiVersion: v1
kind: Service
metadata:
  name: config-server
  namespace: dotstat
spec:
  selector: { app: config-server }
  ports:
    - port: 80
      targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sfs
  namespace: dotstat
spec:
  replicas: 1
  selector: { matchLabels: { app: sfs } }
  template:
    metadata:
      labels: { app: sfs }
    spec:
      initContainers:
        - name: wait-for-config
          image: busybox:1.36
          command: ["sh","-lc"]
          args:
            - |
              echo "Waiting for config-server:80 ...";
              until nc -z -w 2 config-server 80; do echo "config-server not ready yet"; sleep 2; done
      containers:
        - name: sfs
          image: siscc/dotstatsuite-sdmx-faceted-search:causality
          env:
            - name: DEFAULT_TENANT
              valueFrom: { configMapKeyRef: { name: dotstat-config, key: TENANT_ID } }
            - name: CONFIG_URL
              value: http://config-server
            - name: MONGODB_URL
              value: mongodb://mongo:27017
            - name: MONGODB_DATABASE
              value: sfs
            - name: SOLR_HOST
              value: solr-svc
            - name: SOLR_PORT
              value: "8983"
            - name: API_KEY
              valueFrom: { secretKeyRef: { name: dotstat-secrets, key: SEARCH_API_KEY } }
          ports:
            - containerPort: 80
          readinessProbe:
            tcpSocket: { port: 80 }
            initialDelaySeconds: 5
            periodSeconds: 5
          livenessProbe:
            tcpSocket: { port: 80 }
            initialDelaySeconds: 15
            periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: sfs
  namespace: dotstat
spec:
  selector: { app: sfs }
  ports:
    - port: 80
      targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: maildev
  namespace: dotstat
spec:
  replicas: 1
  selector: { matchLabels: { app: maildev } }
  template:
    metadata:
      labels: { app: maildev }
    spec:
      containers:
        - name: maildev
          image: maildev/maildev:latest
          env:
            - name: MAILDEV_SMTP_PORT
              valueFrom: { configMapKeyRef: { name: dotstat-config, key: MAILDEV_INCOMING_MAIL_PORT } }
          ports:
            - containerPort: 1080
            - containerPort: 25
---
apiVersion: v1
kind: Service
metadata:
  name: maildev
  namespace: dotstat
spec:
  selector: { app: maildev }
  ports:
    - name: http
      port: 1080
      targetPort: 1080
    - name: smtp
      port: 25
      targetPort: 25
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: transfer-service
  namespace: dotstat
spec:
  replicas: 1
  selector: { matchLabels: { app: transfer-service } }
  template:
    metadata:
      labels: { app: transfer-service }
    spec:
      containers:
        - name: transfer-service
          image: siscc/dotstatsuite-core-transfer:icecream
          env:
            - name: ServiceId
              value: transfer-service
            - name: DotStatSuiteCoreCommonDbConnectionString
              valueFrom: { secretKeyRef: { name: dotstat-secrets, key: COMMON_CS } }
            - name: DefaultLanguageCode
              value: en
            - name: SpacesInternal__0__Id
              value: production
            - name: SpacesInternal__0__DotStatSuiteCoreStructDbConnectionString
              valueFrom: { secretKeyRef: { name: dotstat-secrets, key: MAPPING_CS } }
            - name: SpacesInternal__0__DotStatSuiteCoreDataDbConnectionString
              valueFrom: { secretKeyRef: { name: dotstat-secrets, key: DATA_CS } }
            - name: ASPNETCORE_URLS
              value: http://0.0.0.0:8080
            - name: auth__enabled
              value: "false"
            - name: auth__allowAnonymous
              value: "true"
            - name: AuthorizationManagement__AllowAnonymous
              value: "true"
            - name: AuthorizationManagement__Enabled
              value: "false"
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: transfer-service
  namespace: dotstat
spec:
  selector: { app: transfer-service }
  ports:
    - port: 80
      targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: dotstat
spec:
  replicas: 1
  selector: { matchLabels: { app: auth-service } }
  template:
    metadata:
      labels: { app: auth-service }
    spec:
      containers:
        - name: auth-service
          image: siscc/dotstatsuite-core-auth-management:icecream
          env:
            - name: auth__enabled
              value: "false"
            - name: auth__authority
              valueFrom: { configMapKeyRef: { name: dotstat-config, key: KEYCLOAK_AUTHORITY_URL } }
            - name: auth__clientId
              valueFrom: { configMapKeyRef: { name: dotstat-config, key: KEYCLOAK_CLIENT_ID } }
            - name: auth__authorizationUrl
              valueFrom: { configMapKeyRef: { name: dotstat-config, key: KEYCLOAK_AUTH_URL } }
            - name: auth__scopes__0
              value: openid
            - name: auth__scopes__1
              value: profile
            - name: auth__scopes__2
              value: email
            - name: auth__claimsMapping__email
              value: email
            - name: auth__claimsMapping__groups
              value: groups
            - name: auth__requireHttps
              value: "false"
            - name: auth__validateIssuer
              value: "false"
            - name: DotStatSuiteCoreCommonDbConnectionString
              valueFrom: { secretKeyRef: { name: dotstat-secrets, key: COMMON_CS } }
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: dotstat
spec:
  selector: { app: auth-service }
  ports:
    - port: 80
      targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nsiws-production
  namespace: dotstat
spec:
  replicas: 1
  selector: { matchLabels: { app: nsiws-production } }
  template:
    metadata:
      labels: { app: nsiws-production }
    spec:
      containers:
        - name: nsiws
          image: siscc/sdmxri-nsi-maapi:icecream
          env:
            - name: auth__enabled
              value: "false"
            - name: auth__allowAnonymous
              value: "true"
            - name: auth__authority
              valueFrom: { configMapKeyRef: { name: dotstat-config, key: KEYCLOAK_AUTHORITY_URL } }
            - name: auth__clientId
              valueFrom: { configMapKeyRef: { name: dotstat-config, key: KEYCLOAK_CLIENT_ID } }
            - name: auth__requireHttps
              value: "false"
            - name: auth__validateIssuer
              value: "false"
            - name: auth__showPii
              value: "true"
            - name: mappingStore__Id__Default
              value: production
            - name: DotStatSuiteCoreCommonDbConnectionString
              valueFrom: { secretKeyRef: { name: dotstat-secrets, key: COMMON_CS } }
            - name: SQL_SERVER
              value: sqlserver
            - name: SQL_DATABASE
              valueFrom: { secretKeyRef: { name: dotstat-secrets, key: MAPPING_DATABASE_NAME } }
            - name: SQL_USER
              valueFrom: { secretKeyRef: { name: dotstat-secrets, key: MAPPING_DATABASE_USER } }
            - name: SQL_PASSWORD
              valueFrom: { secretKeyRef: { name: dotstat-secrets, key: MAPPING_DATABASE_PASSWORD } }
            - name: SQL_PROVIDER
              value: System.Data.SqlClient
            - name: disseminationDbConnection__dbType
              value: SqlServer
            - name: disseminationDbConnection__connectionString
              valueFrom: { secretKeyRef: { name: dotstat-secrets, key: DATA_CS } }
            - name: MA_SQL_USER
              valueFrom: { secretKeyRef: { name: dotstat-secrets, key: MAPPING_DATABASE_USER } }
            - name: MA_SQL_PASSWORD
              valueFrom: { secretKeyRef: { name: dotstat-secrets, key: MAPPING_DATABASE_PASSWORD } }
            - name: MA_ALWAYS_RESET
              value: "Y"
            - name: INSERT_NEW_ITEM_SCHEME_VALUES
              value: "true"
            - name: SENDER_ID
              value: production-DotStatV8
            - name: enableReleaseManagement
              value: "true"
            - name: excludeNonCodedDimensionsDuringConstraintCalculation
              value: "true"
            - name: maxNumberObservationsToSortForPaginatedRequests
              value: "1000000"
            - name: applyContentConstraintsOnDataQueries
              value: "true"
            - name: DOTSTAT__AUTHORIZATIONRULES__ENABLED
              value: "false"
            - name: DOTSTAT__AUTHORIZATIONRULES__BASEURI
              value: http://keycloak:8080/realms/demo
            - name: DOTSTAT__AUTHORIZATIONRULES__BASEURL
              value: http://keycloak:8080/realms/demo
            - name: AUTHORIZATIONRULES__ENABLED
              value: "false"
            - name: AuthorizationRules__Enabled
              value: "false"
            - name: authorization__enabled
              value: "false"
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: nsiws-production
  namespace: dotstat
spec:
  selector: { app: nsiws-production }
  ports:
    - port: 80
      targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: data-explorer
  namespace: dotstat
spec:
  replicas: 1
  selector: { matchLabels: { app: data-explorer } }
  template:
    metadata:
      labels: { app: data-explorer }
    spec:
      nodeSelector:
        kubernetes.io/hostname: k3d-dotstat-server-0
      containers:
        - name: data-explorer
          image: siscc/dotstatsuite-data-explorer:causality
          lifecycle:
            postStart:
              exec:
                command: ["/bin/sh", "-c", "rm -f /opt/build/static/js/*.br || true"]
          env:
            - name: CONFIG_URL
              value: "http://config-server"
            - name: DEFAULT_TENANT
              valueFrom: { configMapKeyRef: { name: dotstat-config, key: TENANT_ID } }
          ports:
            - containerPort: 80
          volumeMounts:
            - name: config-data
              mountPath: /opt/build/assets
              subPath: assets
      volumes:
        - name: config-data
          persistentVolumeClaim:
            claimName: pvc-config-data
---
apiVersion: v1
kind: Service
metadata:
  name: data-explorer
  namespace: dotstat
spec:
  selector: { app: data-explorer }
  ports:
    - port: 80
      targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lifecycle-manager
  namespace: dotstat
spec:
  replicas: 1
  selector: { matchLabels: { app: lifecycle-manager } }
  template:
    metadata:
      labels: { app: lifecycle-manager }
    spec:
      nodeSelector:
        kubernetes.io/hostname: k3d-dotstat-server-0
      containers:
        - name: lifecycle-manager
          image: siscc/dotstatsuite-data-lifecycle-manager:causality
          lifecycle:
            postStart:
              exec:
                command: ["/bin/sh", "-c", "rm -f /opt/build/static/js/*.br || true"]
          env:
            - name: CONFIG_URL
              value: "http://config-server"
            - name: DEFAULT_TENANT
              valueFrom: { configMapKeyRef: { name: dotstat-config, key: TENANT_ID } }
            - name: SERVER_PORT
              value: "80"
            - name: TRANSFER_SERVER_URL
              value: http://transfer.local/2
            - name: AUTHZ_SERVER_URL
              value: http://auth.local/1.1
            - name: SFS_URL
              value: http://sfs.local/admin
            - name: SFS_API_KEY
              valueFrom: { secretKeyRef: { name: dotstat-secrets, key: SEARCH_API_KEY } }
          ports:
            - containerPort: 80
          volumeMounts:
            - name: config-data
              mountPath: /opt/build/assets
              subPath: assets
      volumes:
        - name: config-data
          persistentVolumeClaim:
            claimName: pvc-config-data
---
apiVersion: v1
kind: Service
metadata:
  name: lifecycle-manager
  namespace: dotstat
spec:
  selector: { app: lifecycle-manager }
  ports:
    - port: 80
      targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: data-viewer
  namespace: dotstat
spec:
  replicas: 1
  selector: { matchLabels: { app: data-viewer } }
  template:
    metadata:
      labels: { app: data-viewer }
    spec:
      nodeSelector:
        kubernetes.io/hostname: k3d-dotstat-server-0
      containers:
        - name: data-viewer
          image: siscc/dotstatsuite-data-viewer:causality
          lifecycle:
            postStart:
              exec:
                command: ["/bin/sh", "-c", "rm -f /opt/build/static/js/*.br || true"]
          env:
            - name: CONFIG_URL
              value: "http://config-server"
            - name: DEFAULT_TENANT
              valueFrom: { configMapKeyRef: { name: dotstat-config, key: TENANT_ID } }
          ports:
            - containerPort: 80
          volumeMounts:
            - name: config-data
              mountPath: /opt/build/assets
              subPath: assets
      volumes:
        - name: config-data
          persistentVolumeClaim:
            claimName: pvc-config-data
---
apiVersion: v1
kind: Service
metadata:
  name: data-viewer
  namespace: dotstat
spec:
  selector: { app: data-viewer }
  ports:
    - port: 80
      targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: share
  namespace: dotstat
spec:
  replicas: 1
  selector: { matchLabels: { app: share } }
  template:
    metadata:
      labels: { app: share }
    spec:
      nodeSelector:
        kubernetes.io/hostname: k3d-dotstat-server-0
      containers:
        - name: share
          image: siscc/dotstatsuite-share:causality
          lifecycle:
            postStart:
              exec:
                command: ["/bin/sh", "-c", "rm -f /opt/build/static/js/*.br || true"]
          env:
            - name: CONFIG_URL
              value: "http://config-server"
            - name: DEFAULT_TENANT
              valueFrom: { configMapKeyRef: { name: dotstat-config, key: TENANT_ID } }
            - name: MONGODB_URL
              value: mongodb://mongo:27017
            - name: MONGODB_DATABASE
              value: share
          ports:
            - containerPort: 3007
          volumeMounts:
            - name: config-data
              mountPath: /opt/build/assets
              subPath: assets
      volumes:
        - name: config-data
          persistentVolumeClaim:
            claimName: pvc-config-data
---
apiVersion: v1
kind: Service
metadata:
  name: share
  namespace: dotstat
spec:
  selector: { app: share }
  ports:
    - port: 80
      targetPort: 3007
---
