apiVersion: apps/v1
kind: Deployment
metadata:
  name: config-raw
  namespace: dotstat
spec:
  replicas: 1
  selector: { matchLabels: { app: config-raw } }
  template:
    metadata:
      labels: { app: config-raw }
    spec:
      nodeSelector:
        kubernetes.io/hostname: k3d-dotstat-server-0
      containers:
        - name: nginx
          image: nginx:1.25-alpine
          ports:
            - containerPort: 80
          volumeMounts:
            - name: www
              mountPath: /usr/share/nginx/html
            - name: conf
              mountPath: /etc/nginx/conf.d
      volumes:
        - name: www
          persistentVolumeClaim:
            claimName: pvc-config-data
        - name: conf
          configMap:
            name: config-raw-nginx
---
apiVersion: v1
kind: Service
metadata:
  name: config-raw
  namespace: dotstat
spec:
  selector: { app: config-raw }
  ports:
    - port: 80
      targetPort: 80
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: config-raw-nginx
  namespace: dotstat
data:
  default.conf: |
    server {
      listen 80;
      server_name _;
      # Serve files from the mounted PV directly, with CORS for SPAs
      location / {
        # CORS (allow our local hosts)
        set $cors_origin "";
        if ($http_origin ~* "^(http://explorer\\.local|http://lifecycle\\.local|http://sfs\\.local)$") {
          set $cors_origin $http_origin;
        }
        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
        if ($request_method = OPTIONS) { return 204; }
        autoindex on;
        root /usr/share/nginx/html;
      }
    }
